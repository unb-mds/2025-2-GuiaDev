name: CI Pipeline (Docker Compose)

on:
  push:
    branches: [ main, integracaoRelease2 ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build, Lint and Test Full Stack (Docker Compose)
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Baixa o repositÃ³rio
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file for backend
        run: |
        
          mkdir -p ./backend/backend-nest
          
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ./backend/backend-nest/.env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> ./backend/backend-nest/.env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> ./backend/backend-nest/.env
          echo "GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }}" >> ./backend/backend-nest/.env
          echo "GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }}" >> ./backend/backend-nest/.env

      # 2ï¸âƒ£ Configura o Docker Buildx (build avanÃ§ado + cache)
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ Faz cache de camadas Docker (para builds mais rÃ¡pidos)
      - name: âš¡ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 4ï¸âƒ£ ConstrÃ³i os serviÃ§os do docker-compose
      - name: ğŸ”§ Build Docker Compose services
        run: docker compose -f docker-compose.yml build

      # 5ï¸âƒ£ Sobe os containers em background
      - name: ğŸš€ Start containers
        # run: docker compose -f docker-compose.yml up -d
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NODE_ENV: production
        run: docker compose up -d --build || docker compose logsse vox

        

      # 6ï¸âƒ£ Aplica o linter no backend (ajuste o caminho se necessÃ¡rio)
      - name: ğŸ§¹ Run Linter (NestJS)
        run: docker compose exec -T backend npm run lint

      # 7ï¸âƒ£ Executa testes unitÃ¡rios no backend
      - name: ğŸ§ª Run Tests (NestJS)
        run: docker compose exec -T nest-app npm run test -- --passWithNoTests --runInBand

      # 8ï¸âƒ£ (Opcional) Verifica se o front estÃ¡ rodando
      - name: ğŸŒ Check frontend container health
        run: docker compose ps

      # 9ï¸âƒ£ Para e remove containers apÃ³s os testes
      - name: ğŸ§¼ Clean up
        if: always()
        run: docker compose -f docker-compose.yml down --volumes --remove-orphans
